{% load static %}
{% load socialaccount %}
<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ReLife - –ê—É—Ç–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ü–∏—è</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="{% static 'css/LoginPage.css' %}">
</head>
<body>
    <div class="register-container">
        <h2>–° –≤–æ–∑–≤—Ä–∞—â–µ–Ω–∏–µ–º! üîê</h2>
        <div class="social-buttons">
            <a href="{% url 'social:begin' 'google-oauth2' %}" class="social-btn">
                <img src="https://www.google.com/favicon.ico" alt="Google" width="20">
                –í—Ö–æ–¥ —Å –ø–æ–º–æ—â—å—é Google
            </a>
            <a href="{% url 'social:begin' 'vk-oauth2' %}" class="social-btn">
                <img src="https://vk.com/favicon.ico" alt="VK" width="20">
                –í—Ö–æ–¥ —Å –ø–æ–º–æ—â—å—é VKontakte
            </a>
            <a href="{% url 'login_redirect' %}?action=login" class="social-btn">
                <img src="{% static 'images/123.png' %}" alt="AuthService" width="20">
                –í—Ö–æ–¥ —á–µ—Ä–µ–∑ Auth Service
            </a>
        </div>
        <div class="divider">–ò–ª–∏ –≤–æ–π—Ç–∏ —Å –ø–æ–º–æ—â—å—é</div>
        {% if messages %}
            <div class="messages">
                {% for message in messages %}
                    <p>{{ message }}</p>
                {% endfor %}
            </div>
        {% endif %}
        <div id="error-message" class="messages"></div>
        <form class="register-form" method="POST">
            {% csrf_token %}
            {{ form.username }}
            {% if form.username.errors %}
                <ul class="errorlist">
                    {% for error in form.username.errors %}
                        <li>{{ error }}</li>
                    {% endfor %}
                </ul>
            {% endif %}
            {{ form.password }}
            {% if form.password.errors %}
                <ul class="errorlist">
                    {% for error in form.password.errors %}
                        <li>{{ error }}</li>
                    {% endfor %}
                </ul>
            {% endif %}
            <button type="submit" class="register-btn">–í–æ–π—Ç–∏ üöÄ</button>
        </form>
        <a class="forgotten_text" href="{% url 'register' %}">–ó–∞–±—ã–ª–∏ –ø–∞—Ä–æ–ª—å?</a>
        <div class="links">
            –í–ø–µ—Ä–≤—ã–µ –∑–¥–µ—Å—å? <a href="{% url 'register' %}">–†–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è ‚ûï</a>
        </div>
    </div>
    <script>
        function getCsrfToken() {
            const name = 'csrftoken';
            let cookieValue = null;
            if (document.cookie && document.cookie !== '') {
                const cookies = document.cookie.split(';');
                for (let i = 0; i < cookies.length; i++) {
                    const cookie = cookies[i].trim();
                    if (cookie.substring(0, name.length + 1) === (name + '=')) {
                        cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                        break;
                    }
                }
            }
            console.log("CSRF Token:", cookieValue);
            return cookieValue;
        }

        async function fetchWithCsrf(url, options = {}) {
            const modifiedOptions = {
                ...options,
                headers: {
                    ...options.headers,
                    "X-CSRFToken": getCsrfToken(),
                },
                credentials: "include",
            };

            let response = await fetch(url, modifiedOptions);
            return response;
        }

        document.querySelector('.register-form').addEventListener('submit', async (event) => {
            event.preventDefault();

            const form = event.target;
            const formData = new FormData(form);
            const errorMessageDiv = document.getElementById('error-message');

            try {
                const response = await fetchWithCsrf('/login/', {
                    method: 'POST',
                    body: formData,
                });

                const contentType = response.headers.get('content-type');
                if (contentType && contentType.includes('application/json')) {
                    const data = await response.json();
                    if (data.success) {
                        errorMessageDiv.innerHTML = '<p style="color: green;">–í—Ö–æ–¥ —É—Å–ø–µ—à–µ–Ω! –ü–µ—Ä–µ–Ω–∞–ø—Ä–∞–≤–ª—è–µ–º...</p>';
                        setTimeout(() => {
                            window.location.href = data.redirect_url || '/dashboard/';
                        }, 1000);
                    } else {
                        errorMessageDiv.innerHTML = `<p>${data.error || '–ù–µ–∏–∑–≤–µ—Å—Ç–Ω–∞—è –æ—à–∏–±–∫–∞'}</p>`;
                    }
                } else {
                    const html = await response.text();
                    const parser = new DOMParser();
                    const doc = parser.parseFromString(html, 'text/html');
                    const newContainer = doc.querySelector('.register-container');
                    if (newContainer) {
                        document.querySelector('.register-container').innerHTML = newContainer.innerHTML;
                        const newForm = document.querySelector('.register-form');
                        if (newForm) {
                            newForm.addEventListener('submit', arguments.callee);
                        }
                    }
                    errorMessageDiv.innerHTML = '';
                }
            } catch (error) {
                console.error('–û—à–∏–±–∫–∞ –≤—Ö–æ–¥–∞:', error);
                errorMessageDiv.innerHTML = `<p>–û—à–∏–±–∫–∞ –ø—Ä–∏ –≤—Ö–æ–¥–µ: ${error.message}</p>`;
            }
        });
    </script>
</body>
</html>